module OmniAuth
  module LDAP
    class Adaptor
      class LdapError < ::StandardError
      end

      class ConfigurationError < ::StandardError
      end

      class AuthenticationError < ::StandardError
      end

      class ConnectionError < ::StandardError
      end

      VALID_ADAPTER_CONFIGURATION_KEYS: Array[Symbol]
      MUST_HAVE_KEYS: Array[untyped]
      ENCRYPTION_METHOD: Hash[Symbol, Symbol?]

      attr_accessor bind_dn: String?
      attr_accessor password: String?

      # Net::LDAP is provided by the net-ldap gem; we reference it here for clarity.
      attr_reader connection: Net::LDAP
      attr_reader uid: String?
      attr_reader base: String?
      # auth is the hash passed to Net::LDAP#auth or similar
      attr_reader auth: Hash[Symbol, untyped]
      # filter is an LDAP filter string when configured
      attr_reader filter: String?
      # optional: request password policy control and capture response
      attr_reader password_policy: bool?
      attr_reader last_operation_result: untyped
      attr_reader last_password_policy_response: untyped

      # Validate that required keys exist in the configuration
      def self.validate: (?Hash[Symbol, untyped]) -> void
      def initialize: (?Hash[Symbol, untyped]) -> void

      # Perform a search and optionally bind; returns the matched entry or false
      def bind_as: (?Hash[Symbol, untyped]) -> (Net::LDAP::Entry? | false)

      private

      # Returns encryption settings hash or nil
      def encryption_options: () -> Hash[Symbol, untyped]?
      # Translate configured method/encryption into Net::LDAP symbol
      def translate_method: () -> Symbol?
      # Returns a Net::LDAP encryption default options hash
      def default_options: () -> Hash[Symbol, untyped]
      # Sanitize provided TLS options
      def sanitize_hash_values: (Hash[untyped, untyped]) -> Hash[untyped, untyped]
      # Symbolize option keys
      def symbolize_hash_keys: (Hash[untyped, untyped]) -> Hash[Symbol, untyped]
      # Capture password policy control from last operation
      def capture_password_policy: (Net::LDAP) -> void

      # Returns an array of SASL auth hashes
      def sasl_auths: (?Hash[Symbol, untyped]) -> Array[Hash[Symbol, untyped]]

      # Returns initial credential and a proc that accepts a challenge and returns the response
      def sasl_bind_setup_digest_md5: (?Hash[Symbol, untyped]) -> Array[untyped]
      def sasl_bind_setup_gss_spnego: (?Hash[Symbol, untyped]) -> Array[untyped]

      @try_sasl: bool?
      @allow_anonymous: bool?
      @tls_options: Hash[untyped, untyped]?
      @sasl_mechanisms: Array[String]?
      @disable_verify_certificates: bool?
    end
  end
end
